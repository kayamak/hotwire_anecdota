---
title: "TurboとStimulus: どっちを使う？"
section: Tips
layout: section
order: 020
---

## Hotwireはいろんな技術から構成されている --- hotwire-composition

Hotwireは大きくTurbo, Stimulus, Nativeの技術から構成されています。そしてTurboはさらにTurbo Drive, Turbo Frames, Turbo Streamsに分かれています。ここでは TurboとStimulus の使い分けについて解説します。

![hotwire-component-structure.webp](content_images/hotwire-component-structure.webp)

## TurboとStimulusの役割は？ --- roles-of-turbo-and-stimulus

まず先に[Native](https://native.hotwired.dev)に言及します。Nativeはネイティブなモバイルアプリを作るためのツールで、Reactの世界で言えばReact Nativeに相当します。HTMLで書かれたウェブアプリから出発して、徐々にネイティブアプリ化するやり方です。ここではウェブアプリの作成に着目しますので、これ以上お話ししません。

ここではTurboとStimulusをどう組み合わせて使うかを紹介します。

![interactive-flow.webp](content_images/interactive-flow.webp)

* Turboはサーバに非同期でリクエストを投げて、レスポンスを処理するのが主な役割です
    * 一番多い`a`タグや`form`タグについては、イベントハンドラーも提供します 。Reactのように`onClick`や`onSubmit`をハンドルしなくても簡単なケースなら処理できます
    * 表示中の画面を部分的に置換する形でレスポンスを処理します
* Turboは基本的な非同期処理の機能を提供しますが、さらに細かい動作をさせたい場合はStimulusが使えます
    * Turboで処理する前後に、StimulusでJavaScriptを起動できます
    * `a`タグや`form`タグのイベント以外にも、Stimulusを使えばあらゆるイベントに対応できます（例えばリアルタイム検索なら`oninput`、キーボードショートカットなら`keydown/up`なら）
    * Turboはレスポンスイベントを発火しますので、Stimulusで受け取って追加処理ができます（例えばform送信が成功したらモーダルを自動的に閉じるなど）
* サーバと非同期通信をしない場合（ブラウザだけで処理できる場合）はStimulusだけを使います
    * 生のJavaScriptやjQueryに比べて、Stimulusはイベントハンドラーを整理しやすく、DOMが変わった場合に繋げ直しも自動でやってくれますので、コードのメンテナンス性が向上します
    * イベント呼び出しをHTMLに記述しますので、HTMLとJavaScriptの結合度は生まれますが、処理の流れはわかりやすくなります

## 非同期通信が必要かどうかの判断は複雑 --- do-you-need-server-communication

上述のように、Turboはサーバとの非同期通信が必要な時だけに使用します。ブラウザ内だけで完了する場合はStimulusだけを使います。しかしこの判断は意外とと単純ではありません。下記のことを考えながら最終判断をする必要があります。

* **サーバから最新情報が必要か？:** サーバから常に最新の情報が欲しいのであれば、Turboを使ってサーバと非同期通信を行うしかありません
* **HTMLは更新するか？:** Stimulusで大きくHTMLを書き換えるのは一般的に避けます。CSSクラスの変更やデータの変更ぐらいは問題ありませんが、新しいコンポーネントを表示するような変更はなるべくやりません
* **レスポンスはなるべく早くしたいか？:** HTMLを大きく書き換える場合であっても、レスポンスをなるべく早くしたい時があります。例えばポスト詳細の画面から編集画面に切り替えたい時などです。編集画面を表示するためにわざわざサーバ通信するのは時間の無駄な可能性があります。この場合は詳細画面と編集画面を双方とも読み込んでおき、必要に応じてStimulusで表示・非表示を切り替えられます。また「いいね」ボタンでオン・オフ状態を切り替えたい時、サーバからのレスポンスを待っているともっさりしたUI/UXになります。この場合もStimulus等で楽観的UI(Optimistic UI)を作ります。

![Turbo or Stimulus](content_images/turbo-or-stimulus.webp)

## 私のやり方: 時期尚早な最適化を避ける --- how-i-do-it

上述のように、TurboとStimulusのどれを使うかは単純ではありません。開発の初期から考えすぎないことも重要です。私は通常、下記の順番で開発しています。

1. 最初は実装のしやすさを重視します。通常、一番実装しやすいのはMPAですので、画面の部分置換をしないMPAで実装します。Turbo Driveのおかげで、MPAとして作ってもSPAのサクサク感がありますので、これだけで十分ということがほとんどです
2. 次にTurbo FramesやTurbo Streamsを使って、画面の部分置換を少しずつ導入します。通常は数行の小さな変更で済みますが、コードは僅かでも間違いなく複雑化していますので、なるべくわかりやすさを保つように意識します
3. 最後にUI/UXの不足分をStimulusで補います
4. レスポンスの速さが問題になる場合はもう少し大きな変更が必要になりますが、すでにTurbo Framesなどで実装されていれば難しくはありません

インタラクティブUI/UXは最適化と捉えるのが良いと思います。[時期尚早な最適化を避ける](https://ja.wikipedia.org/wiki/最適化_(情報工学)#最適化する時期)意味でもMPAから出発し、段階的にインタラクティブな要素を追加するのが良いのではないかと思います。

経験の浅いデザイナーの場合は、実装コストを深く考えないで過剰にインタラクティブなデザインを作ってしまうことがあります。そのような場合でも、うまく考えて、コードのわかりやすさを保ちつつ、ステップを踏みながらUI/UXを作ることをお勧めします。
