---
title: Stimulusとステート
section: Tips
layout: section
order: 030
---

## Stimulusのステートの考え方

![Stimulus State](content_images/stimulus_state.webp)

Reactにおけるステートは、基本的には`useState`または`useContext`から返されるステート変数を指します。ステートがRedux Store, URL, cookie, localStorage等に保管されているケースもありますが、常に`useState`と同じような仕組みで利用することになります。またステートは勝手に変更してはならず、必ず用意された関数でセットする必要があります(`useState`の場合は第２引数)。

それに対してStimulusはステート管理に明確なルールはありません。ステートとしては何を使っても良いのですが、一般的にはDOMそのものを使います。HTML要素の`data-*-value`や`class`等の属性についてはStimulusが用意している機能がありますが、特にこれに限らず、何を使っても問題ありません。また直接URL, cookie, localStorage等をステートとして使っても良いでしょう。

## ステート管理の実例

ここではApple Storeを模写しながら、Turbo, Stimulusのステートの使い方を考えてみます。Apple Storeの場合は以下の要件があります。

* オプションを選択すると、それに応じてリアルタイムで表示価格が変更されます
    * 合計金額
    * 各オプションの隣に表示される合計価格 (例えば現在のモデルのRAMを1TBに変更した時に合計はいくらになるか)
* カラーオプションを選択すると、それに応じて適切な画像が表示されます
* 前のオプションを選択するまで、次のオプションは選択不可能状態にします

つまり選択されたオプションに応じて価格計算を行い、それを画面の複数箇所に反映させる必要があります。その他にもそれぞれの要素の状態が変化します

### サーバにステートを持たせた場合

1. オプションが選択される都度、サーバにTurbo Streamsでリクエストを送信します
2. サーバは再計算された価格等をすべて反映したHTMLを返してきます
3. レスポンスのTurbo Streamsを画面に反映させて、新しい状態の価格等を表示します
4. この際、単にHTMLを置換するのではなく、Morphing(差分検出処理)を行い、ブラウザステートを維持します。これはReactが再レンダリングのたびに行うものと同じ考えです

* ロジックはすべてサーバサイドに保持されます

### ブラウザにステートを持たせた場合

選択されたオプションが変更されても、サーバ通信をせずに、ブラウザ内で表示価格を適切にアップデートしたり、各オプションの選択可能ステートを変更したりするものです。価格表全体をあらかじめブラウザにロードします

